<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz ‚Äì Linux CLI Quiz</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #0f172a;
        color: #e5e7eb;
        line-height: 1.5;
      }
      header {
        padding: 1rem 1.5rem;
        background: #020617;
        border-bottom: 1px solid #1f2937;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .header-inner {
        max-width: 960px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .badge-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .badge-icon {
        font-size: 1.5rem;
      }
      .badge-name {
        font-size: 1.1rem;
        font-weight: 600;
      }
      .progress-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.9rem;
        color: #9ca3af;
      }
      .chicken-counter {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.8rem;
        border-radius: 999px;
        background: rgba(245, 158, 11, 0.15);
        border: 1px solid rgba(245, 158, 11, 0.3);
        color: #fcd34d;
      }
      .glasses-counter {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.8rem;
        border-radius: 999px;
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: #93c5fd;
      }
      .cancel-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #fca5a5;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
      }
      .cancel-btn:hover {
        background: rgba(239, 68, 68, 0.25);
        border-color: rgba(239, 68, 68, 0.5);
      }
      main {
        max-width: 960px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }
      .quiz-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 1rem;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .quiz-question {
        margin-bottom: 2rem;
      }
      .quiz-question-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #e5e7eb;
      }
      .quiz-question-meta {
        font-size: 0.85rem;
        color: #9ca3af;
        margin-bottom: 1.5rem;
      }
      .quiz-options {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
      .quiz-option {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 1rem;
        border-radius: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .quiz-option:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(59, 130, 246, 0.3);
      }
      .quiz-option input[type="radio"] {
        margin-top: 0.2rem;
        cursor: pointer;
      }
      .quiz-option.highlight-correct {
        background: rgba(34, 197, 94, 0.15);
        border-color: rgba(34, 197, 94, 0.5);
      }
      .quiz-command-wrapper {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .quiz-command-input {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        color: #e5e7eb;
        font-family: "Courier New", monospace;
        font-size: 1rem;
      }
      .quiz-command-input:focus {
        outline: none;
        border-color: rgba(59, 130, 246, 0.5);
        background: rgba(255, 255, 255, 0.08);
      }
      .quiz-command-input.correct {
        border-color: rgba(34, 197, 94, 0.5);
        background: rgba(34, 197, 94, 0.1);
      }
      .quiz-command-input.incorrect {
        border-color: rgba(239, 68, 68, 0.5);
        background: rgba(239, 68, 68, 0.1);
      }
      .quiz-chicken-btn,
      .quiz-chicken-btn-command {
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        background: rgba(245, 158, 11, 0.15);
        border: 1px solid rgba(245, 158, 11, 0.3);
        color: #fcd34d;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
      }
      .quiz-chicken-btn:hover:not(:disabled),
      .quiz-chicken-btn-command:hover:not(:disabled) {
        background: rgba(245, 158, 11, 0.25);
        border-color: rgba(245, 158, 11, 0.5);
      }
      .quiz-chicken-btn:disabled,
      .quiz-chicken-btn-command:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .quiz-glasses-btn,
      .quiz-glasses-btn-command {
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.3);
        color: #93c5fd;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
        position: relative;
      }
      .quiz-glasses-btn:hover:not(:disabled),
      .quiz-glasses-btn-command:hover:not(:disabled) {
        background: rgba(59, 130, 246, 0.25);
        border-color: rgba(59, 130, 246, 0.5);
      }
      .quiz-glasses-btn:disabled,
      .quiz-glasses-btn-command:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .quiz-tips-dropdown {
        position: absolute;
        top: calc(100% + 0.5rem);
        left: 0;
        min-width: 350px;
        max-width: 500px;
        background: rgba(30, 41, 59, 0.98);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 0.5rem;
        padding: 1rem;
        padding-top: 2.5rem;
        z-index: 1000;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 1rem;
      }
      .quiz-tips-dropdown.hidden {
        display: none;
      }
      .quiz-tips-section {
        margin-bottom: 1rem;
      }
      .quiz-tips-section:last-child {
        margin-bottom: 0;
      }
      .quiz-tips-section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #93c5fd;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .quiz-tips-flag-item {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 0.25rem;
      }
      .quiz-tips-flag-item:last-child {
        margin-bottom: 0;
      }
      .quiz-tips-flag {
        font-family: "Courier New", monospace;
        color: #60a5fa;
        font-weight: 600;
        min-width: 80px;
      }
      .quiz-tips-flag-desc {
        color: #cbd5e1;
        font-size: 0.9rem;
      }
      .quiz-tips-syntax {
        font-family: "Courier New", monospace;
        background: rgba(0, 0, 0, 0.3);
        padding: 0.5rem 0.75rem;
        border-radius: 0.25rem;
        color: #93c5fd;
        margin: 0.5rem 0;
        font-size: 0.9rem;
      }
      .quiz-tips-example {
        font-family: "Courier New", monospace;
        background: rgba(0, 0, 0, 0.3);
        padding: 0.5rem 0.75rem;
        border-radius: 0.25rem;
        color: #86efac;
        margin: 0.5rem 0;
        font-size: 0.85rem;
      }
      .quiz-tips-note {
        font-size: 0.85rem;
        color: #9ca3af;
        font-style: italic;
        margin-top: 0.25rem;
      }
      .quiz-tips-close {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: transparent;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        transition: all 0.2s ease;
      }
      .quiz-tips-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #e5e7eb;
      }
      .quiz-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }
      .quiz-next-btn,
      .quiz-finish-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        background: linear-gradient(135deg, #3b82f6, #60a5fa);
        color: #ffffff;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .quiz-next-btn:hover:not(:disabled),
      .quiz-finish-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      }
      .quiz-next-btn:disabled,
      .quiz-finish-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .quiz-feedback {
        padding: 1rem;
        border-radius: 0.5rem;
        margin-top: 1rem;
        font-size: 0.9rem;
      }
      .quiz-feedback.success {
        background: rgba(34, 197, 94, 0.15);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #86efac;
      }
      .quiz-feedback.error {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #fca5a5;
      }
      .quiz-completion {
        text-align: center;
        padding: 3rem 2rem;
      }
      .quiz-completion-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1rem;
      }
      .quiz-completion-message {
        font-size: 1.1rem;
        color: #9ca3af;
        margin-bottom: 2rem;
      }
      .quiz-completion.success .quiz-completion-title {
        color: #86efac;
      }
      .quiz-completion.failed .quiz-completion-title {
        color: #fca5a5;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-inner">
        <div class="badge-info">
          <span class="badge-icon" id="badge-icon">üß≠</span>
          <span class="badge-name" id="badge-name">Badge Name</span>
        </div>
        <div class="progress-info">
          <span id="progress-text">Frage 1 von 10</span>
          <div class="chicken-counter">
            <span>üêî</span>
            <span id="chicken-count">0/3</span>
          </div>
          <div class="glasses-counter">
            <span>üëì</span>
            <span id="glasses-count">0/6</span>
          </div>
          <div
            class="chicken-counter"
            style="
              background: rgba(239, 68, 68, 0.15);
              border-color: rgba(239, 68, 68, 0.3);
              color: #fca5a5;
            "
          >
            <span>‚ùå</span>
            <span id="wrong-count">0/3</span>
          </div>
          <button class="cancel-btn" id="cancel-btn">Abbrechen</button>
        </div>
      </div>
    </header>
    <main>
      <div class="quiz-container">
        <div id="quiz-content">
          <!-- Quiz-Fragen werden hier eingef√ºgt -->
        </div>
        <div id="quiz-completion" class="quiz-completion hidden">
          <!-- Completion-Nachricht wird hier eingef√ºgt -->
        </div>
      </div>
    </main>

    <script>
      // URL-Parameter lesen
      const urlParams = new URLSearchParams(window.location.search);
      const badgeId = urlParams.get("badge");

      if (!badgeId) {
        document.body.innerHTML = `
          <div style="padding: 2rem; text-align: center;">
            <h1>Fehler</h1>
            <p>Kein Badge angegeben. Bitte von der Startseite aus starten.</p>
            <a href="index.html" style="color: #60a5fa;">Zur√ºck zur Startseite</a>
          </div>
        `;
      }

      // Lade Daten aus index.html per iframe
      let quizData = {};
      let badgeSegments = [];

      async function loadQuizData() {
        try {
          // Versuche Daten aus localStorage zu laden (falls index.html bereits geladen wurde)
          const storedQuizData = sessionStorage.getItem("quizDataCache");
          const storedBadgeSegments =
            sessionStorage.getItem("badgeSegmentsCache");

          if (storedQuizData && storedBadgeSegments) {
            try {
              quizData = JSON.parse(storedQuizData);
              badgeSegments = JSON.parse(storedBadgeSegments);
              console.log("Daten aus Cache geladen");
              initQuiz();
              return;
            } catch (e) {
              console.warn("Cache-Daten ung√ºltig, lade neu:", e);
            }
          }

          // Daten nicht in sessionStorage gefunden
          throw new Error("Daten nicht verf√ºgbar");
        } catch (error) {
          console.error("Fehler beim Laden der Daten:", error);
          document.body.innerHTML = `
            <div style="padding: 2rem; text-align: center; max-width: 600px; margin: 2rem auto;">
              <h1 style="color: #fca5a5; font-size: 1.5rem; margin-bottom: 1rem;">‚ö†Ô∏è Quiz-Daten nicht gefunden</h1>
              <p style="margin: 1rem 0; color: #e5e7eb;">Die Quiz-Daten konnten nicht geladen werden.</p>
              <div style="font-size: 0.9rem; color: #9ca3af; margin-top: 1.5rem; padding: 1.5rem; background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 0.5rem; text-align: left;">
                <strong style="color: #fcd34d; font-size: 1rem;">üìã So behebst du das Problem:</strong><br><br>
                1. √ñffne zuerst <a href="index.html" style="color: #60a5fa; text-decoration: underline; font-weight: 600;">index.html</a> im Browser<br>
                2. Warte bis die Seite vollst√§ndig geladen ist (alle Scripts m√ºssen ausgef√ºhrt sein)<br>
                3. Klicke dann auf den Quiz-Button f√ºr dein Badge<br><br>
                <strong style="color: #fcd34d;">Warum?</strong> Die Quiz-Daten werden beim Laden von index.html in den Browser-Cache (sessionStorage) gespeichert.
              </div>
              <div style="font-size: 0.85rem; color: #9ca3af; margin-top: 1.5rem; text-align: left; background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 0.5rem;">
                <strong style="color: #93c5fd;">üí° Alternativ:</strong> Nutze einen lokalen Webserver:<br>
                <code style="background: rgba(0,0,0,0.3); padding: 0.5rem 1rem; border-radius: 0.25rem; display: block; margin-top: 0.5rem; color: #60a5fa; font-family: monospace;">python -m http.server 8000</code>
                <br>Dann √∂ffne: <code style="background: rgba(0,0,0,0.3); padding: 0.25rem 0.5rem; border-radius: 0.25rem; color: #60a5fa; font-family: monospace;">http://localhost:8000/index.html</code>
              </div>
              <a href="index.html" style="color: #60a5fa; margin-top: 1.5rem; display: inline-block; text-decoration: underline; font-weight: 600; font-size: 1.1rem; padding: 0.75rem 1.5rem; border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 0.5rem; background: rgba(96, 165, 250, 0.1);">‚Üê Zur√ºck zur Startseite</a>
            </div>
          `;
        }
      }

      // Quiz-State
      let currentQuestionIndex = 0;
      let chickenUsed = 0;
      let glassesUsed = 0;
      let wrongAnswers = 0;
      let answers = [];
      let allQuestions = [];
      let currentSegment = null;
      let quizFailed = false;
      let wrongAnsweredQuestions = new Set();
      let commandMeta = {};

      function initQuiz() {
        // Finde Segment
        currentSegment = badgeSegments.find((s) => s.id === badgeId);
        if (!currentSegment) {
          document.body.innerHTML = `
            <div style="padding: 2rem; text-align: center;">
              <h1>Fehler</h1>
              <p>Badge nicht gefunden.</p>
              <a href="index.html" style="color: #60a5fa;">Zur√ºck zur Startseite</a>
            </div>
          `;
          return;
        }

        // Setze Badge-Info
        document.getElementById("badge-icon").textContent = currentSegment.icon;
        document.getElementById("badge-name").textContent = currentSegment.name;

        // Sammle alle Fragen aus allen Quizzes des Badges
        allQuestions = [];
        currentSegment.quizIds.forEach((quizId, quizIndex) => {
          const quiz = quizData[quizId];
          if (quiz && quiz.questions) {
            quiz.questions.forEach((question, qIndex) => {
              allQuestions.push({
                ...question,
                quizId: quizId,
                globalIndex: allQuestions.length,
              });
            });
          }
        });

        if (allQuestions.length === 0) {
          document.body.innerHTML = `
            <div style="padding: 2rem; text-align: center;">
              <h1>Fehler</h1>
              <p>Keine Fragen f√ºr dieses Badge gefunden.</p>
              <a href="index.html" style="color: #60a5fa;">Zur√ºck zur Startseite</a>
            </div>
          `;
          return;
        }

        // Initialisiere Antworten-Array
        answers = new Array(allQuestions.length).fill(null);
        // Reset falsch beantwortete Fragen
        wrongAnsweredQuestions.clear();

        // Zeige erste Frage
        showQuestion(0);

        // Cancel-Button Handler
        document.getElementById("cancel-btn").addEventListener("click", () => {
          if (
            confirm(
              "M√∂chtest du das Quiz wirklich abbrechen? Dein Fortschritt geht verloren."
            )
          ) {
            window.location.href = "index.html";
          }
        });
      }

      function showQuestion(index) {
        if (index >= allQuestions.length) {
          finishQuiz();
          return;
        }

        currentQuestionIndex = index;
        const question = allQuestions[index];

        // Update Progress
        document.getElementById("progress-text").textContent = `Frage ${
          index + 1
        } von ${allQuestions.length}`;
        document.getElementById(
          "chicken-count"
        ).textContent = `${chickenUsed}/3`;
        document.getElementById(
          "glasses-count"
        ).textContent = `${glassesUsed}/6`;
        document.getElementById(
          "wrong-count"
        ).textContent = `${wrongAnswers}/3`;

        // Render Frage
        const quizContent = document.getElementById("quiz-content");
        quizContent.innerHTML = "";

        const questionDiv = document.createElement("div");
        questionDiv.className = "quiz-question";

        const title = document.createElement("div");
        title.className = "quiz-question-title";
        title.textContent = question.prompt;

        const meta = document.createElement("div");
        meta.className = "quiz-question-meta";
        meta.textContent = `Level: ${question.level}`;

        questionDiv.appendChild(title);
        questionDiv.appendChild(meta);

        if (question.type === "command") {
          // Command-Input-Frage
          const commandWrapper = document.createElement("div");
          commandWrapper.className = "quiz-command-wrapper";

          const input = document.createElement("input");
          input.type = "text";
          input.className = "quiz-command-input";
          input.placeholder = "Tippe den Befehl hier ein...";
          if (answers[index]) {
            input.value = answers[index];
            if (answers[index] === question.correctCommand) {
              input.classList.add("correct");
            }
          }

          input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              validateCommandAnswer(input, question, index);
            }
          });

          input.addEventListener("blur", () => {
            if (input.value.trim()) {
              validateCommandAnswer(input, question, index);
            }
          });

          const buttonContainer = document.createElement("div");
          buttonContainer.style.display = "flex";
          buttonContainer.style.gap = "0.75rem";
          buttonContainer.style.flexWrap = "wrap";

          const glassesBtn = document.createElement("button");
          glassesBtn.type = "button";
          glassesBtn.className = "quiz-glasses-btn-command";
          glassesBtn.textContent = "üëì Tipp anzeigen";
          glassesBtn.disabled = glassesUsed >= 6;
          glassesBtn.addEventListener("click", () => {
            if (glassesUsed < 6) {
              showTipsDropdown(glassesBtn, question, question.quizId);
              glassesUsed++;
              updateGlassesCounter();
              glassesBtn.disabled = glassesUsed >= 6;
            }
          });

          const chickenBtn = document.createElement("button");
          chickenBtn.type = "button";
          chickenBtn.className = "quiz-chicken-btn-command";
          chickenBtn.textContent = "üêî L√∂sung zeigen";
          chickenBtn.disabled = chickenUsed >= 3;
          chickenBtn.addEventListener("click", () => {
            if (chickenUsed < 3) {
              showCommandSolution(input, question, index);
              chickenUsed++;
              answers[index] = question.correctCommand;
              updateChickenCounter();
              chickenBtn.disabled = chickenUsed >= 3;
            }
          });

          buttonContainer.appendChild(glassesBtn);
          buttonContainer.appendChild(chickenBtn);
          commandWrapper.appendChild(input);
          commandWrapper.appendChild(buttonContainer);
          questionDiv.appendChild(commandWrapper);
        } else {
          // Multiple-Choice-Frage
          const optionsDiv = document.createElement("div");
          optionsDiv.className = "quiz-options";

          question.options.forEach((option, optIndex) => {
            const label = document.createElement("label");
            label.className = "quiz-option";
            if (answers[index] === optIndex) {
              if (optIndex === question.correctIndex) {
                label.classList.add("highlight-correct");
              }
            }

            const radio = document.createElement("input");
            radio.type = "radio";
            radio.name = `question_${index}`;
            radio.value = optIndex;
            radio.checked = answers[index] === optIndex;
            radio.addEventListener("change", () => {
              answers[index] = optIndex;

              // Entferne highlight-correct von allen Optionen
              optionsDiv.querySelectorAll("label").forEach((l) => {
                l.classList.remove("highlight-correct");
              });

              if (optIndex === question.correctIndex) {
                label.classList.add("highlight-correct");
              } else {
                // Falsche Antwort gew√§hlt - z√§hle nur einmal pro Frage
                if (!wrongAnsweredQuestions.has(index)) {
                  wrongAnsweredQuestions.add(index);
                  wrongAnswers++;
                  document.getElementById(
                    "wrong-count"
                  ).textContent = `${wrongAnswers}/3`;
                  // Pr√ºfe ob Quiz gescheitert ist
                  if (wrongAnswers >= 3) {
                    setTimeout(() => {
                      handleQuizFailure("Du hast 3x falsch geantwortet.");
                    }, 500);
                    return;
                  }
                }
              }
              updateNavigation();
            });

            const text = document.createElement("span");
            text.innerHTML = option;

            label.appendChild(radio);
            label.appendChild(text);
            optionsDiv.appendChild(label);
          });

          const buttonContainer = document.createElement("div");
          buttonContainer.style.display = "flex";
          buttonContainer.style.gap = "0.75rem";
          buttonContainer.style.flexWrap = "wrap";

          const glassesBtn = document.createElement("button");
          glassesBtn.type = "button";
          glassesBtn.className = "quiz-glasses-btn";
          glassesBtn.textContent = "üëì Tipp anzeigen";
          glassesBtn.disabled = glassesUsed >= 6;
          glassesBtn.addEventListener("click", () => {
            if (glassesUsed < 6) {
              showTipsDropdown(glassesBtn, question, question.quizId);
              glassesUsed++;
              updateGlassesCounter();
              glassesBtn.disabled = glassesUsed >= 6;
            }
          });

          const chickenBtn = document.createElement("button");
          chickenBtn.type = "button";
          chickenBtn.className = "quiz-chicken-btn";
          chickenBtn.textContent = "üêî L√∂sung zeigen";
          chickenBtn.disabled = chickenUsed >= 3;
          chickenBtn.addEventListener("click", () => {
            if (chickenUsed < 3) {
              showMultipleChoiceSolution(optionsDiv, question, index);
              chickenUsed++;
              answers[index] = question.correctIndex;
              updateChickenCounter();
              chickenBtn.disabled = chickenUsed >= 3;
            }
          });

          buttonContainer.appendChild(glassesBtn);
          buttonContainer.appendChild(chickenBtn);
          questionDiv.appendChild(optionsDiv);
          questionDiv.appendChild(buttonContainer);
        }

        // Navigation
        const navigation = document.createElement("div");
        navigation.className = "quiz-navigation";

        const nextBtn = document.createElement("button");
        nextBtn.className =
          index === allQuestions.length - 1
            ? "quiz-finish-btn"
            : "quiz-next-btn";
        nextBtn.textContent =
          index === allQuestions.length - 1 ? "Abschlie√üen" : "Weiter";
        nextBtn.disabled = answers[index] === null;
        nextBtn.addEventListener("click", () => {
          if (index === allQuestions.length - 1) {
            finishQuiz();
          } else {
            showQuestion(index + 1);
          }
        });

        navigation.appendChild(nextBtn);
        questionDiv.appendChild(navigation);

        quizContent.appendChild(questionDiv);
        updateNavigation();
      }

      function validateCommandAnswer(input, question, index) {
        const userAnswer = input.value.trim();
        if (!userAnswer) {
          return; // Keine Validierung bei leerem Input
        }

        const correctCommand = question.correctCommand.trim();
        const acceptedVariants = question.acceptedVariants || [];

        // Normalisiere Antworten
        const normalize = (cmd) => cmd.toLowerCase().replace(/\s+/g, " ");

        const isCorrect =
          normalize(userAnswer) === normalize(correctCommand) ||
          acceptedVariants.some(
            (variant) => normalize(userAnswer) === normalize(variant)
          );

        if (isCorrect) {
          input.classList.remove("incorrect");
          input.classList.add("correct");
          answers[index] = userAnswer;
        } else {
          input.classList.remove("correct");
          input.classList.add("incorrect");
          answers[index] = userAnswer;

          // Z√§hle falsche Antwort nur einmal pro Frage
          if (!wrongAnsweredQuestions.has(index)) {
            wrongAnsweredQuestions.add(index);
            wrongAnswers++;
            document.getElementById(
              "wrong-count"
            ).textContent = `${wrongAnswers}/3`;
            // Pr√ºfe ob Quiz gescheitert ist
            if (wrongAnswers >= 3) {
              setTimeout(() => {
                handleQuizFailure("Du hast 3x falsch geantwortet.");
              }, 500);
              return;
            }
          }
        }

        updateNavigation();
      }

      function showCommandSolution(input, question, index) {
        input.value = question.correctCommand;
        input.classList.remove("incorrect");
        input.classList.add("correct");
        answers[index] = question.correctCommand;
        updateNavigation();
      }

      function showMultipleChoiceSolution(optionsDiv, question, index) {
        const labels = optionsDiv.querySelectorAll("label");
        labels.forEach((label, labelIndex) => {
          if (labelIndex === question.correctIndex) {
            label.classList.add("highlight-correct");
            const radio = label.querySelector("input[type='radio']");
            if (radio) radio.checked = true;
          } else {
            label.classList.remove("highlight-correct");
          }
        });
        answers[index] = question.correctIndex;
        updateNavigation();
      }

      function updateChickenCounter() {
        document.getElementById(
          "chicken-count"
        ).textContent = `${chickenUsed}/3`;
      }

      function updateGlassesCounter() {
        document.getElementById(
          "glasses-count"
        ).textContent = `${glassesUsed}/6`;
      }

      // Generiere Tipps f√ºr eine Frage basierend auf den Quiz-Daten
      function getTipsForQuestion(question, quizId) {
        const tips = {
          flags: [],
          syntax: [],
          examples: [],
          hints: [],
        };

        // Versuche Quiz-Daten zu finden
        const quiz = quizId && quizData[quizId] ? quizData[quizId] : null;

        // Hole Flags aus Quiz-Daten
        if (quiz && quiz.flags) {
          tips.flags = quiz.flags.map((f) => ({
            flag: f.flag || f,
            description: f.description || "",
          }));
        }

        // Hole Examples aus Quiz-Daten
        if (quiz) {
          if (quiz.simpleExample) {
            tips.examples.push({
              command: quiz.simpleExample,
              note: "Einfaches Beispiel",
            });
          }
          if (quiz.complexExample) {
            tips.examples.push({
              command: quiz.complexExample,
              note: quiz.complexExampleExplanation || "Erweitertes Beispiel",
            });
          }
          if (quiz.additionalExamples) {
            tips.examples.push(...quiz.additionalExamples);
          }
        }

        // F√ºr Command-Fragen: Extrahiere Befehl und generiere Tipps
        if (question.type === "command" && question.correctCommand) {
          const cmd = question.correctCommand.trim();

          // Extrahiere Basis-Befehl (erste Wort)
          const baseCommand = cmd.split(/\s+/)[0].split(/[|&;]/)[0];

          // Generiere Syntax-Hinweise basierend auf dem Befehl
          if (cmd.includes("&&")) {
            tips.syntax.push(
              "&& verbindet Befehle - der zweite Befehl wird nur ausgef√ºhrt, wenn der erste erfolgreich war"
            );
          }
          if (cmd.includes("|")) {
            tips.syntax.push(
              "| leitet die Ausgabe eines Befehls als Eingabe an den n√§chsten weiter"
            );
          }
          if (cmd.includes(">")) {
            tips.syntax.push(
              "> leitet die Ausgabe in eine Datei um (√ºberschreibt)"
            );
          }
          if (cmd.includes(">>")) {
            tips.syntax.push(">> h√§ngt die Ausgabe an eine Datei an");
          }
          if (cmd.includes("-")) {
            const flags = cmd.match(/-\w+/g);
            if (flags) {
              flags.forEach((flag) => {
                tips.flags.push({
                  flag: flag,
                  description: `Das Flag ${flag} wird in diesem Befehl verwendet`,
                });
              });
            }
          }

          // Basis-Syntax f√ºr h√§ufige Befehle
          if (baseCommand === "mkdir" && cmd.includes("-p")) {
            tips.flags.push({
              flag: "-p",
              description: "erstellt alle fehlenden Zwischenverzeichnisse",
            });
          }
          if (baseCommand === "cp" && cmd.includes("-r")) {
            tips.flags.push({
              flag: "-r",
              description: "kopiert Verzeichnisse rekursiv",
            });
          }
          if (baseCommand === "chmod" && cmd.includes("+x")) {
            tips.flags.push({
              flag: "+x",
              description: "setzt das Ausf√ºhrungsbit",
            });
          }
          if (baseCommand === "ls" && cmd.includes("-a")) {
            tips.flags.push({
              flag: "-a",
              description: "zeigt versteckte Dateien",
            });
          }
          if (baseCommand === "ls" && cmd.includes("-l")) {
            tips.flags.push({
              flag: "-l",
              description: "lange Ausgabe mit Details",
            });
          }
        }

        // F√ºr Multiple-Choice: Extrahiere Hinweise aus den Optionen
        if (!question.type || question.type !== "command") {
          // Pr√ºfe ob Optionen Command-Referenzen enthalten
          if (question.options) {
            question.options.forEach((opt) => {
              const codeMatch = opt.match(/`([^`]+)`/);
              if (codeMatch) {
                const code = codeMatch[1];
                if (code.includes("-")) {
                  const flagMatch = code.match(/-(\w+)/);
                  if (flagMatch) {
                    tips.flags.push({
                      flag: `-${flagMatch[1]}`,
                      description: "Dieses Flag k√∂nnte relevant sein",
                    });
                  }
                }
              }
            });
          }
        }

        return tips;
      }

      // Zeige Dropdown mit Tipps
      function showTipsDropdown(button, question, quizId) {
        // Schlie√üe bereits ge√∂ffnete Dropdowns
        const existingDropdown = document.querySelector(
          ".quiz-tips-dropdown:not(.hidden)"
        );
        if (existingDropdown) {
          existingDropdown.classList.add("hidden");
        }

        const tips = getTipsForQuestion(question, quizId);

        // Erstelle Dropdown
        const dropdown = document.createElement("div");
        dropdown.className = "quiz-tips-dropdown";

        let html =
          '<button class="quiz-tips-close" onclick="this.parentElement.classList.add(\'hidden\')">√ó</button>';

        // Flags-Sektion
        if (tips.flags.length > 0) {
          html +=
            '<div class="quiz-tips-section"><div class="quiz-tips-section-title">üìã Relevante Flags</div>';
          tips.flags.forEach((flag) => {
            html += `<div class="quiz-tips-flag-item">
              <span class="quiz-tips-flag">${flag.flag}</span>
              <span class="quiz-tips-flag-desc">${flag.description || ""}</span>
            </div>`;
          });
          html += "</div>";
        }

        // Syntax-Sektion
        if (tips.syntax.length > 0) {
          html +=
            '<div class="quiz-tips-section"><div class="quiz-tips-section-title">üî§ Syntax & Operatoren</div>';
          tips.syntax.forEach((s) => {
            html += `<div class="quiz-tips-syntax">${s}</div>`;
          });
          html += "</div>";
        }

        // Examples-Sektion (ohne die L√∂sung zu verraten)
        if (tips.examples.length > 0) {
          html +=
            '<div class="quiz-tips-section"><div class="quiz-tips-section-title">üí° √Ñhnliche Beispiele</div>';
          tips.examples.forEach((ex) => {
            html += `<div class="quiz-tips-example">${ex.command || ex}</div>`;
            if (ex.note) {
              html += `<div class="quiz-tips-note">${ex.note}</div>`;
            }
          });
          html += "</div>";
        }

        // Wenn keine Tipps gefunden, zeige generische Hilfe
        if (
          tips.flags.length === 0 &&
          tips.syntax.length === 0 &&
          tips.examples.length === 0
        ) {
          html +=
            '<div class="quiz-tips-section"><div class="quiz-tips-section-title">üí° Tipp</div>';
          html +=
            '<div class="quiz-tips-flag-desc">Lies die Frage genau und √ºberlege, welche Befehle und Flags f√ºr diese Aufgabe relevant sein k√∂nnten.</div>';
          html += "</div>";
        }

        dropdown.innerHTML = html;

        // Positioniere Dropdown relativ zum Button-Container
        const buttonContainer = button.parentElement;
        if (
          buttonContainer &&
          buttonContainer.classList.contains("quiz-command-wrapper")
        ) {
          // F√ºr Command-Wrapper: Dropdown am Wrapper anh√§ngen
          buttonContainer.style.position = "relative";
          buttonContainer.appendChild(dropdown);
        } else {
          // F√ºr andere Buttons: Dropdown am Button anh√§ngen
          button.style.position = "relative";
          button.appendChild(dropdown);
        }

        // Schlie√üe bei Klick au√üerhalb
        setTimeout(() => {
          const closeHandler = (e) => {
            if (
              !dropdown.contains(e.target) &&
              e.target !== button &&
              !button.contains(e.target)
            ) {
              dropdown.classList.add("hidden");
              document.removeEventListener("click", closeHandler);
            }
          };
          document.addEventListener("click", closeHandler);
        }, 100);
      }

      function handleQuizFailure(reason) {
        quizFailed = true;
        const quizContent = document.getElementById("quiz-content");
        const completion = document.getElementById("quiz-completion");
        quizContent.classList.add("hidden");
        completion.classList.remove("hidden");
        completion.className = "quiz-completion failed";
        completion.innerHTML = `
          <div class="quiz-completion-title">‚ùå Quiz gescheitert</div>
          <div class="quiz-completion-message">
            ${reason}<br>
            Falsche Antworten: ${wrongAnswers}/3<br>
            Chicken-Button verwendet: ${chickenUsed}/3<br>
            Lesebrillen-Button verwendet: ${glassesUsed}/6
          </div>
          <button class="quiz-finish-btn" onclick="window.location.href='index.html'">
            Zur√ºck zur Startseite
          </button>
        `;
      }

      function updateNavigation() {
        const nextBtn = document.querySelector(
          ".quiz-next-btn, .quiz-finish-btn"
        );
        if (nextBtn) {
          nextBtn.disabled = answers[currentQuestionIndex] === null;
        }
      }

      function finishQuiz() {
        // Pr√ºfe ob Quiz bereits gescheitert ist
        if (quizFailed) {
          return;
        }

        // Pr√ºfe alle Antworten
        let correctCount = 0;
        allQuestions.forEach((question, index) => {
          if (question.type === "command") {
            const userAnswer = answers[index];
            const correctCommand = question.correctCommand.trim();
            const acceptedVariants = question.acceptedVariants || [];
            const normalize = (cmd) => cmd.toLowerCase().replace(/\s+/g, " ");
            if (
              userAnswer &&
              (normalize(userAnswer) === normalize(correctCommand) ||
                acceptedVariants.some(
                  (variant) => normalize(userAnswer) === normalize(variant)
                ))
            ) {
              correctCount++;
            }
          } else {
            if (answers[index] === question.correctIndex) {
              correctCount++;
            }
          }
        });

        const allCorrect = correctCount === allQuestions.length;
        const canGetBadge =
          allCorrect &&
          chickenUsed <= 3 &&
          glassesUsed <= 6 &&
          wrongAnswers < 3;

        // Zeige Completion-Nachricht
        const quizContent = document.getElementById("quiz-content");
        const completion = document.getElementById("quiz-completion");
        quizContent.classList.add("hidden");
        completion.classList.remove("hidden");

        if (canGetBadge) {
          completion.className = "quiz-completion success";
          completion.innerHTML = `
            <div class="quiz-completion-title">üéâ Badge erhalten!</div>
            <div class="quiz-completion-message">
              Du hast alle Fragen richtig beantwortet und das Badge "${currentSegment.name}" erhalten!
            </div>
            <button class="quiz-finish-btn" onclick="window.location.href='index.html?highlight=${badgeId}'">
              Zur√ºck zur Startseite
            </button>
          `;

          // Speichere Badge-Status
          let badgeSaturated = {};
          const stored = localStorage.getItem("badgeSaturated");
          if (stored) {
            try {
              badgeSaturated = JSON.parse(stored);
            } catch (e) {
              badgeSaturated = {};
            }
          }
          badgeSaturated[badgeId] = true;
          localStorage.setItem(
            "badgeSaturated",
            JSON.stringify(badgeSaturated)
          );

          // Update badgeProgress
          let badgeProgress = {};
          const progressStored = localStorage.getItem("badgeProgress");
          if (progressStored) {
            try {
              badgeProgress = JSON.parse(progressStored);
            } catch (e) {
              badgeProgress = {};
            }
          }
          badgeProgress[badgeId] = currentSegment.quizIds.length;
          localStorage.setItem("badgeProgress", JSON.stringify(badgeProgress));
        } else {
          completion.className = "quiz-completion failed";
          let reason = "";
          if (wrongAnswers >= 3) {
            reason = "Du hast 3x falsch geantwortet.";
          } else if (!allCorrect) {
            reason = "Nicht alle Fragen wurden richtig beantwortet.";
          } else if (chickenUsed > 3) {
            reason = "Du hast mehr als 3x den Chicken-Button verwendet.";
          } else if (glassesUsed > 6) {
            reason = "Du hast mehr als 6x den Lesebrillen-Button verwendet.";
          }
          completion.innerHTML = `
            <div class="quiz-completion-title">‚ùå Badge nicht erhalten</div>
            <div class="quiz-completion-message">
              ${reason}<br>
              Richtige Antworten: ${correctCount}/${allQuestions.length}<br>
              Falsche Antworten: ${wrongAnswers}/3<br>
              Chicken-Button verwendet: ${chickenUsed}/3<br>
              Lesebrillen-Button verwendet: ${glassesUsed}/6
            </div>
            <button class="quiz-finish-btn" onclick="window.location.href='index.html'">
              Zur√ºck zur Startseite
            </button>
          `;
        }
      }

      // Starte Quiz wenn Seite geladen ist
      if (badgeId) {
        loadQuizData();
      }
    </script>
  </body>
</html>
