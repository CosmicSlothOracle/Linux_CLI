<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Auto-Test Runner</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        #test-output {
            background: #000;
            padding: 15px;
            border: 2px solid #00ff00;
            border-radius: 5px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success { background: #004400; color: #00ff00; }
        .error { background: #440000; color: #ff0000; }
        .info { background: #000044; color: #0088ff; }
    </style>
</head>
<body>
    <h1>üß™ Quiz Auto-Test Runner</h1>
    <p>Dieser Test √∂ffnet automatisch 2 Quiz-Modals und l√∂st sie.</p>
    <button onclick="startTest()">‚ñ∂Ô∏è Test starten</button>
    <div id="status"></div>
    <div id="test-output"></div>

    <script>
        // Lade index.html in einen iframe, um Zugriff auf die Quiz-Funktionen zu haben
        const iframe = document.createElement('iframe');
        iframe.src = 'index.html';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);

        let output = document.getElementById('test-output');
        let status = document.getElementById('status');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;

            if (type === 'error') {
                console.error(message);
            } else if (type === 'success') {
                console.log(message);
            } else {
                console.info(message);
            }
        }

        function setStatus(message, className) {
            status.innerHTML = `<div class="status ${className}">${message}</div>`;
        }

        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function startTest() {
            output.textContent = '';
            setStatus('‚è≥ Warte auf index.html...', 'info');

            // Warte bis iframe geladen ist
            await new Promise((resolve) => {
                iframe.onload = resolve;
                if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
                    resolve();
                }
            });

            await sleep(2000); // Zus√§tzliche Wartezeit f√ºr Initialisierung

            const iframeWindow = iframe.contentWindow;
            const iframeDoc = iframe.contentDocument;

            if (!iframeWindow || !iframeDoc) {
                setStatus('‚ùå Fehler: Konnte nicht auf iframe zugreifen', 'error');
                log('‚ùå Fehler: Konnte nicht auf iframe zugreifen', 'error');
                return;
            }

            log('‚úÖ index.html geladen');
            setStatus('üöÄ Test l√§uft...', 'info');

            try {
                // Pr√ºfe ob Funktionen verf√ºgbar sind
                if (!iframeWindow.openQuiz) {
                    throw new Error('openQuiz Funktion nicht gefunden');
                }
                if (!iframeWindow.quizData) {
                    throw new Error('quizData nicht gefunden');
                }

                const testReport = {
                    startTime: new Date().toISOString(),
                    tests: [],
                    summary: { total: 0, passed: 0, failed: 0, errors: [] }
                };

                const testQuizIds = ['pwd', 'cd'];

                for (const quizId of testQuizIds) {
                    log(`\nüìù Teste Quiz: ${quizId}`);

                    try {
                        await sleep(500);

                        log(`  ‚Üí √ñffne Quiz-Modal f√ºr ${quizId}`);
                        iframeWindow.openQuiz(quizId);

                        await sleep(800);

                        const quiz = iframeWindow.quizData[quizId];
                        if (!quiz) {
                            throw new Error(`Quiz-Daten f√ºr ${quizId} nicht gefunden`);
                        }

                        const quizBodyBack = iframeDoc.getElementById('quiz-body-back');
                        if (!quizBodyBack) {
                            throw new Error('quiz-body-back Element nicht gefunden');
                        }

                        const questionEls = Array.from(quizBodyBack.querySelectorAll('.quiz-question'));
                        log(`  ‚Üí Gefunden: ${questionEls.length} Fragen`);

                        let questionsAnswered = 0;

                        for (let idx = 0; idx < questionEls.length; idx++) {
                            const questionEl = questionEls[idx];
                            const question = quiz.questions[idx];

                            if (!question) {
                                log(`  ‚ö†Ô∏è Frage ${idx + 1} nicht in Quiz-Daten gefunden`, 'error');
                                continue;
                            }

                            await sleep(200);

                            if (question.type === 'command') {
                                const commandInput = questionEl.querySelector('.quiz-command-input');
                                if (commandInput) {
                                    const correctCommand = question.correctCommand;
                                    log(`  ‚Üí Frage ${idx + 1} (${question.level}): Command-Input`);
                                    log(`    Korrekte Antwort: ${correctCommand}`);

                                    commandInput.value = correctCommand;
                                    commandInput.dispatchEvent(new Event('input', { bubbles: true }));

                                    if (iframeWindow.validateCommandInput) {
                                        iframeWindow.validateCommandInput(commandInput, question);
                                    }

                                    questionsAnswered++;
                                    await sleep(300);
                                }
                            } else {
                                const correctIndex = question.correctIndex;
                                const radioInputs = questionEl.querySelectorAll('input[type="radio"]');

                                if (radioInputs.length > correctIndex) {
                                    log(`  ‚Üí Frage ${idx + 1} (${question.level}): Multiple-Choice`);
                                    log(`    Korrekte Antwort: Index ${correctIndex}`);

                                    const correctRadio = radioInputs[correctIndex];
                                    correctRadio.checked = true;
                                    correctRadio.dispatchEvent(new Event('change', { bubbles: true }));

                                    questionsAnswered++;
                                    await sleep(300);
                                }
                            }
                        }

                        await sleep(500);

                        const quizSubmitBtnBack = iframeDoc.getElementById('quiz-submit-btn-back');
                        if (quizSubmitBtnBack && !quizSubmitBtnBack.disabled) {
                            log(`  ‚Üí Klicke Submit-Button`);

                            const clickEvent = new MouseEvent('click', {
                                view: iframeWindow,
                                bubbles: true,
                                cancelable: true
                            });
                            quizSubmitBtnBack.dispatchEvent(clickEvent);

                            questionsAnswered++;
                        } else {
                            log(`  ‚ö†Ô∏è Submit-Button nicht gefunden oder deaktiviert`, 'error');
                        }

                        await sleep(1000);

                        const quizFeedbackBack = iframeDoc.getElementById('quiz-feedback-back');
                        let feedback = '';
                        if (quizFeedbackBack) {
                            feedback = quizFeedbackBack.textContent || '';
                        }

                        const testResult = {
                            quizId: quizId,
                            quizTitle: quiz.title,
                            questionsTotal: questionEls.length,
                            questionsAnswered: questionsAnswered,
                            feedback: feedback,
                            success: feedback.includes('3/3') || feedback.includes('richtig'),
                            timestamp: new Date().toISOString()
                        };

                        if (testResult.success) {
                            log(`  ‚úÖ Quiz ${quizId} erfolgreich gel√∂st!`, 'success');
                            testReport.summary.passed++;
                        } else {
                            log(`  ‚ùå Quiz ${quizId} fehlgeschlagen. Feedback: ${feedback}`, 'error');
                            testReport.summary.failed++;
                        }

                        testReport.tests.push(testResult);
                        testReport.summary.total++;

                        await sleep(1000);

                    } catch (error) {
                        log(`  ‚ùå Fehler beim Testen von ${quizId}: ${error.message}`, 'error');
                        testReport.summary.errors.push({
                            quizId: quizId,
                            error: error.message
                        });
                        testReport.summary.failed++;
                        testReport.summary.total++;
                    }
                }

                testReport.endTime = new Date().toISOString();
                const duration = new Date(testReport.endTime) - new Date(testReport.startTime);

                log('\nüìä ===== TEST-ZUSAMMENFASSUNG =====');
                log(`Gesamt: ${testReport.summary.total} Tests`);
                log(`‚úÖ Erfolgreich: ${testReport.summary.passed}`, 'success');
                log(`‚ùå Fehlgeschlagen: ${testReport.summary.failed}`, testReport.summary.failed > 0 ? 'error' : 'info');
                log(`‚è±Ô∏è  Dauer: ${(duration / 1000).toFixed(2)}s`);

                if (testReport.summary.errors.length > 0) {
                    log('\n‚ö†Ô∏è Fehler:', 'error');
                    testReport.summary.errors.forEach(err => {
                        log(`  - ${err.quizId}: ${err.error}`, 'error');
                    });
                }

                log('\nüìã Detaillierter Bericht:');
                testReport.tests.forEach(test => {
                    log(`\n  Quiz: ${test.quizId} (${test.quizTitle})`);
                    log(`    Fragen beantwortet: ${test.questionsAnswered}/${test.questionsTotal}`);
                    log(`    Status: ${test.success ? '‚úÖ Erfolgreich' : '‚ùå Fehlgeschlagen'}`, test.success ? 'success' : 'error');
                    log(`    Feedback: ${test.feedback || 'Kein Feedback'}`);
                });

                const statusMsg = testReport.summary.failed === 0
                    ? `‚úÖ Alle Tests erfolgreich! (${testReport.summary.passed}/${testReport.summary.total})`
                    : `‚ö†Ô∏è ${testReport.summary.failed} Test(s) fehlgeschlagen (${testReport.summary.passed}/${testReport.summary.total} erfolgreich)`;
                setStatus(statusMsg, testReport.summary.failed === 0 ? 'success' : 'error');

                window.testReport = testReport;

            } catch (error) {
                log(`‚ùå Kritischer Fehler: ${error.message}`, 'error');
                setStatus(`‚ùå Fehler: ${error.message}`, 'error');
            }
        }

        // Auto-Start nach 1 Sekunde (optional)
        // setTimeout(() => startTest(), 1000);
    </script>
</body>
</html>

